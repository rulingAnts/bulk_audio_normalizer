name: build

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  mac:
    name: macOS universal DMG
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build mac DMG (universal)
        run: npm run dist -- --mac

      - name: Upload mac artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-dmg
          path: |
            dist/*.dmg
            dist/latest-mac.yml

  windows:
    name: Windows portable EXE
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Windows portable
        run: npm run dist -- --win

      - name: Verify Windows ffmpeg/ffprobe binaries exist and are Windows EXEs
        shell: pwsh
        run: |
          $ffmpeg = "dist\win-unpacked\resources\app.asar.unpacked\node_modules\ffmpeg-static\ffmpeg.exe"
          $ffprobe = "dist\win-unpacked\resources\app.asar.unpacked\node_modules\ffprobe-static\bin\win32\x64\ffprobe.exe"
          if (!(Test-Path $ffmpeg)) { Write-Error "ffmpeg.exe missing at $ffmpeg" }
          if (!(Test-Path $ffprobe)) { Write-Error "ffprobe.exe missing at $ffprobe" }
          # Check 'MZ' signature for PE files
          $fs = [System.IO.File]::OpenRead($ffmpeg)
          try {
            $bytes = New-Object byte[] 2; $null = $fs.Read($bytes,0,2)
          } finally { $fs.Close() }
          if ($bytes[0] -ne 0x4D -or $bytes[1] -ne 0x5A) { Write-Error "ffmpeg.exe does not start with 'MZ' (not a Windows EXE?)" }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: |
            dist/*.exe
            dist/win-unpacked/**