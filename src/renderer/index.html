<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; script-src 'self'; media-src 'self' file: data:;" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bulk Audio Normalizer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
  <h1>Bulk Audio Normalizer</h1>
  <p>Converts to 16/24-bit WAV and normalizes by LUFS (for listening) or peak dBFS (for analysis), with safeguards against clipping.</p>
    </header>

    <section id="intro" class="intro">
      <p>
        <span class="icon" aria-hidden="true">üéôÔ∏è</span>
        For linguistic field recordings and phonetics/phonology work: batch-converts to 16‚Äëbit WAV, normalizes to ‚àí16 LUFS with a safety limiter (no clipping), and can trim leading/trailing silence ‚Äî ideal for softly recorded speech without harming analysis.
      </p>
    </section>

    <section id="notice" class="notice">
      <!-- Minimal collapsed -->
      <div id="noticeMin" class="notice-min hidden" role="note" aria-live="polite">
        <div class="notice-corner" aria-hidden="false">
          <button id="btnNoticePlusMin" class="notice-btn" aria-label="Expand notice">+</button>
        </div>
        <span class="icon" aria-hidden="true">‚ö†Ô∏è</span>
        <strong>IMPORTANT</strong><br />&nbsp;<br />
      </div>

      <!-- Brief version -->
      <div id="noticeBrief" class="notice-brief" role="note" aria-live="polite">
        <div class="notice-corner" aria-hidden="false">
          <button id="btnNoticePlusBrief" class="notice-btn" aria-label="Expand notice">+</button>
          <button id="btnNoticeMinusBrief" class="notice-btn" aria-label="Collapse notice">‚àí</button>
        </div>
        <p>
          <span class="icon" aria-hidden="true">‚ö†Ô∏è</span>
          <strong>IMPORTANT:</strong><br />
          &nbsp;<br />Always keep your original, unprocessed recordings as archival masters. This tool supports two normalization intents: <em>Peak dBFS</em> (recommended for acoustic analysis/language documentation; preserves amplitude relationships and headroom) and <em>LUFS</em> (for consistent listening; uses a limiter to prevent clipping). Normalization and silence trimming are generally acceptable for analysis, but document all processing in your methods. Avoid heavy noise reduction, EQ, or compression that could affect formants or timing. See
          <a href="https://www.paradisec.org.au/deposit/audio-video-formats/" target="_blank" rel="noopener">PARADISEC</a> and
          <a href="https://www.elararchive.org/requirements/audio/" target="_blank" rel="noopener">ELAR</a> guidelines for best practices.
        </p>
      </div>

      <!-- Expanded version -->
      <div id="noticeFull" class="notice-full hidden" role="note" aria-live="polite">
        <div class="notice-corner" aria-hidden="false">
          <button id="btnNoticeMinusFull" class="notice-btn" aria-label="Collapse notice">‚àí</button>
        </div>
        <p><span class="icon" aria-hidden="true">‚ö†Ô∏è</span> <strong>IMPORTANT: Data Integrity &amp; Archiving</strong><br /></p>
        <p>This tool can apply normalization and silence trimming to your audio files. Before processing:</p>
        <ul>
          <li><strong>ALWAYS</strong> keep your original, unprocessed recordings ‚Äî these are your archival masters</li>
          <li>Store originals in a lossless format (WAV, FLAC) with no prior processing</li>
          <li>Document all processing steps for your research methods section</li>
        </ul>
        <p>Normalization intents:</p>
        <ul>
          <li><strong>Peak dBFS</strong> (default, recommended for analysis/documentation): Analyze the file‚Äôs peak and boost quiet files up to a target (e.g., ‚àí9 dBFS) without limiting or compression; preserves amplitude relationships and headroom.</li>
          <li><strong>LUFS</strong> (for consistent listening): EBU R128 loudness normalization (typically ‚àí16 LUFS) with a safety limiter to prevent clipping for playback.</li>
          <li>Silence trimming (non-destructive cut of leading/trailing silences) with optional padding and conservative settings.</li>
        </ul>
        <p>What you should NOT do elsewhere:</p>
        <ul>
          <li>Heavy noise reduction affecting formant structure</li>
          <li>Equalization, compression, or pitch correction</li>
          <li>Saving only lossy formats (MP3, AAC) for analysis</li>
        </ul>
        <p>For valid acoustic phonetic analysis: Transparency and consistency matter more than perfect recordings. Document recording conditions, equipment, chosen normalization intent (Peak or LUFS) and targets, and any trimming settings.</p>
        <p>Best practices resources:</p>
        <ul>
          <li>PARADISEC audio guidelines: <a href="https://www.paradisec.org.au/deposit/audio-video-formats/" target="_blank" rel="noopener">https://www.paradisec.org.au/deposit/audio-video-formats/</a></li>
          <li>ELAR deposit requirements: <a href="https://www.elararchive.org/requirements/audio/" target="_blank" rel="noopener">https://www.elararchive.org/requirements/audio/</a></li>
          <li>Linguistic Data Consortium recording guidelines: <a href="https://www.ldc.upenn.edu/language-resources/data/obtaining" target="_blank" rel="noopener">https://www.ldc.upenn.edu/language-resources/data/obtaining</a></li>
        </ul>
        <div class="notice-bottom"></div>
        <div class="notice-actions" style="margin-top:6px;">
          <button id="btnNoticeCollapseMin2" class="linklike">Hide</button>
        </div>
      </div>
    </section>

    <section class="controls">
      <div class="controls-grid">
        <div class="picker">
          <label>Input folder</label>
          <div class="row">
            <input id="inputPath" type="text" placeholder="Choose input folder" readonly />
            <button id="btnInput">Browse‚Ä¶</button>
          </div>
          <div class="hint"></div>
        </div>
        <div class="picker">
          <label>Output folder</label>
          <div class="row">
            <input id="outputPath" type="text" placeholder="Choose output folder" readonly />
            <button id="btnOutput">Browse‚Ä¶</button>
            <button id="btnClearOutput" title="Delete all contents of the output folder">Clear</button>
          </div>
          <div id="outputValidation" class="hint"></div>
        </div>
        <div class="picker">
          <label>Processing profile</label>
          <div class="row">
            <select id="profileSelect">
              <option value="balanced">Balanced (good speed, safe)</option>
              <option value="fast">Fastest (lots of files)</option>
              <option value="quality">Highest quality/safety</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div id="profileDesc" class="hint"></div>
          <div class="row" style="margin-top:6px; align-items:center; gap:8px;">
            <label for="normMode" style="margin:0; font-weight:600;">Normalization intent</label>
            <select id="normMode" title="Participatory Analysis/Human Ears: normalize to ‚àí16 LUFS with a safety limiter (consistent listening). Acoustic Analysis/Language Documentation: set peak level (dBFS) to keep headroom (‚àí12 to ‚àí6 dBFS), suitable for tools like Praat; LUFS isn‚Äôt typically specified for linguistics field work.">
              <option value="peak" selected>Acoustic Analysis / Language Documentation (peak dBFS)</option>
              <option value="lufs">Participatory Analysis / Human Ears (‚àí16 LUFS + limiter)</option>
            </select>
            <span class="info-icon" aria-hidden="true" data-tip="Participatory Analysis/Human Ears: normalize to ‚àí16 LUFS with a safety limiter (consistent listening). Acoustic Analysis/Language Documentation: set peak level (dBFS) to keep headroom (‚àí12 to ‚àí6 dBFS), suitable for tools like Praat; LUFS isn‚Äôt typically specified for linguistics field work.">i</span>
          </div>
          <div class="hint">Peak dBFS boosts quiet files up to a target without limiting or compression (best for Praat/measurement). Use LUFS for consistent listening and reviews.</div>
          <div class="row" style="margin-top:6px; align-items:center; gap:8px;">
            <label for="bitDepth" style="margin:0; font-weight:600;">Target bit depth</label>
            <select id="bitDepth" title="Some archives prefer 24‚Äëbit WAVs; field tools like Dekereke and FieldWorks may require 16‚Äëbit. Many phonologists find 16‚Äëbit sufficient for vowel formants and tone, with much smaller files and lower CPU/RAM load. 'Original (no limit)' keeps the source bit depth and can increase processing load and storage‚Äîgenerally not required by academic archives.">
              <option value="16" selected>16‚Äëbit (smaller, widely compatible)</option>
              <option value="24">24‚Äëbit (limit to 24‚Äëbit; no up‚Äëconvert from 16‚Äëbit)</option>
              <option value="original">Original (no limit)</option>
            </select>
            <span class="info-icon" aria-hidden="true" data-tip="Some archives prefer 24‚Äëbit WAVs; field tools like Dekereke and FieldWorks may require 16‚Äëbit. Many phonologists find 16‚Äëbit sufficient for vowel formants and tone, with much smaller files and lower CPU/RAM load. 'Original (no limit)' keeps the source bit depth and can increase processing load and storage‚Äîgenerally not required by academic archives.">i</span>
          </div>
          <div class="hint">Default to 16‚Äëbit unless your archive requires 24‚Äëbit. ‚ÄúOriginal‚Äù preserves float/bit depth for specialist analysis.</div>
        </div>
        <div class="actions-block">
          <div class="actions">
            <button id="btnStart" disabled>Start</button>
            <button id="btnCancel" disabled aria-label="Stop processing">Stop</button>
            <span id="stopStatus" class="hint" style="margin-left:8px; color:#6e7781;"></span>
          </div>
          <div class="hint"></div>
        </div>
      </div>
    </section>

    <section class="preview">
      <h2>Preview (random spot check)</h2>
      <div class="row">
        <label for="previewCount" class="inline-label">Sample size</label>
        <input id="previewCount" type="number" min="1" max="50" value="5" />
        <button id="btnPreview">Run Preview</button>
      </div>
      <div id="previewInfo" class="hint">Preview is capped at 50 files per run to keep it responsive.</div>
      <div id="previewList" class="preview-list"></div>
    </section>


    <section class="overall">
      <div class="row label-row">
        <span>Overall progress</span>
        <span id="overallCount">0/0</span>
        <span id="overallPct">0%</span>
        <span id="overallTime" class="time">‚Äî</span>
      </div>
      <div class="progress"><div id="overallBar" class="bar" style="width:0%"></div></div>
      <div id="batchStatus" class="hint"></div>
    </section>

    <details id="advSettings" class="settings">
      <summary>Advanced‚Ä¶ <span id="advModePill" class="pill">Mode: Peak dBFS</span></summary>
      <div class="grid">
        <div class="group-title" style="grid-column: 1 / -1; font-weight: 600; margin: 4px 0;">Normalization</div>

        <div class="adv-pair adv-lufs" id="row-lufsTarget">
          <label for="lufsTarget">LUFS target</label>
          <input id="lufsTarget" type="number" step="0.1" value="-16" />
        </div>

        <div class="adv-pair adv-peak" id="row-peakTargetDb">
          <label for="peakTargetDb">Peak target (dBFS)</label>
          <input id="peakTargetDb" type="number" step="0.1" value="-9" />
        </div>

        <div class="adv-pair adv-peak" id="row-peakOnlyBoost">
          <label for="peakOnlyBoost">Only boost (don‚Äôt attenuate) <span class="info-icon" aria-hidden="true" data-tip="Peak mode only: Boost quiet files up to the target peak level; do not turn loud files down.">i</span></label>
          <input id="peakOnlyBoost" type="checkbox" checked />
        </div>

        <div class="adv-pair adv-lufs" id="row-tpMargin">
          <label for="tpMargin">True-peak target (dBFS)</label>
          <input id="tpMargin" type="number" step="0.1" value="-1" />
        </div>

        <div class="adv-pair adv-lufs" id="row-limiterLimit">
          <label for="limiterLimit">Limiter ceiling (linear 0..1)</label>
          <input id="limiterLimit" type="number" step="0.01" min="0" max="1" value="0.97" />
        </div>
        
    <div class="group-title" style="grid-column: 1 / -1; height: 8px;"></div>
    <div class="group-title" style="grid-column: 1 / -1; font-weight: 600; margin: 4px 0;">Performance</div>
  <label for="concurrency">Concurrency <span class="info-icon" aria-hidden="true" data-tip="Files processed at the same time. Recommended: cores ‚àí 1. Higher can be faster but uses more CPU/disk.">i</span></label>
  <input id="concurrency" type="number" min="1" max="16" value="4" title="Files processed at the same time (parallel jobs)" />
        
        <div class="sep" style="grid-column: 1 / -1; height: 8px;"></div>
  
  <label for="fastNormalize">Fast normalize (single pass)</label>
  <input id="fastNormalize" type="checkbox" />

  <label for="ffmpegThreads">FFmpeg threads per process (optional) <span class="info-icon" aria-hidden="true" data-tip="CPU threads per file. 0 = auto. 1 recommended for Balanced. Higher may speed heavy filters but reduces overall parallelism.">i</span></label>
  <input id="ffmpegThreads" type="number" min="0" placeholder="auto" title="CPU threads used per file (0 = auto)" />
        
    <div class="group-title" style="grid-column: 1 / -1; height: 8px;"></div>
    <div class="group-title" style="grid-column: 1 / -1; font-weight: 600; margin: 4px 0;">Trimming</div>
        <label for="autoTrim">Auto-trim leading/trailing silence</label>
        <input id="autoTrim" type="checkbox" checked />

  <label for="trimPadMs">Keep padding each side (ms)</label>
  <input id="trimPadMs" type="number" min="0" value="800" />

        <label for="trimThresholdDb">Silence threshold (dBFS)</label>
        <input id="trimThresholdDb" type="number" step="1" value="-50" />

        <label for="trimMinDurationMs">Minimum silence duration (ms)</label>
        <input id="trimMinDurationMs" type="number" min="0" value="200" />

        <label for="trimMinFileMs">Only trim if file longer than (ms)</label>
        <input id="trimMinFileMs" type="number" min="0" value="800" />

        <label for="trimConservative">Conservative trim (safer for soft voices)</label>
        <input id="trimConservative" type="checkbox" checked />

  <label for="fastTrim">Fast trim (edge scan, no FFmpeg detect)</label>
  <input id="fastTrim" type="checkbox" checked />

        <label for="trimHPF">Pre-filter rumble (HPF 80 Hz)</label>
        <input id="trimHPF" type="checkbox" />

        <div class="sep" style="grid-column: 1 / -1; height: 8px;"></div>
        <div class="group-title" style="grid-column: 1 / -1; font-weight: 600; margin: 4px 0;">Diagnostics</div>
        <label for="verboseLogs">Verbose FFmpeg logs</label>
        <input id="verboseLogs" type="checkbox" />
      </div>
      <div class="hint">Tip: Lower limiter ceiling (e.g., 0.97) for extra headroom. TP is in dBFS (negative values).</div>
    </details>

    <section class="files">
      <details id="filesPanel" class="collapsible" open>
        <summary>File status</summary>
        <div id="fileList" class="file-list"></div>
      </details>
    </section>

    <section class="logs">
      <details id="logPanel" class="collapsible">
        <summary>Debug log</summary>
        <div class="log-actions">
          <button id="btnClearLog">Clear log</button>
        </div>
        <pre id="logView" class="log-view"></pre>
      </details>
    </section>

    <footer>
      <small>Tip: Hundreds of short WAVs are fine. The app won‚Äôt modify originals; it writes new files to the output folder.</small>
      <small style="display:block; margin-top:6px; color:#666;">
        ¬© 2025 Seth Johnston ‚Ä¢ License: GNU Affero General Public License v3 ‚Ä¢ Code generated almost entirely by VS Code Copilot (GPT-5), with some consultation with Claude/Sonet 4.5 about ideal settings for acoustic analysis / language documentation.
      </small>
    </footer>

    <!-- WaveSurfer UMD from local node_modules -->
    <script src="../../node_modules/wavesurfer.js/dist/wavesurfer.min.js"></script>
    <script src="../../node_modules/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
    <script src="renderer.js"></script>
  </body>
</html>
